{% extends "base.html" %}
{% block content %}

<!-- ENCABEZADO + EXPORTACIONES -->
<div class="d-flex align-items-center justify-content-between mb-2">
  <div>
    <h3 class="mb-0">Bandeja de pagos</h3>
    <div class="text-muted small">
      {% set start = (page-1)*per_page + 1 if total else 0 %}
      {% set end = (page-1)*per_page + (pagos|length) %}
      Mostrando {{ start }}–{{ end }} de {{ total }}
    </div>
    {% if counts_by_status %}
    <div class="mt-1 small">
      <a class="badge bg-secondary text-decoration-none me-1"
         href="{{ url_for('admin_bp.admin', estado='PENDIENTE', sociedad=sociedad if sociedad else None, q=q if q else None, desde=desde if desde else None, hasta=hasta if hasta else None, valor_min=valor_min if valor_min else None, valor_max=valor_max if valor_max else None, per_page=per_page) }}">
        Pendientes: {{ counts_by_status['PENDIENTE'] }}
      </a>
      <a class="badge bg-success text-decoration-none me-1"
         href="{{ url_for('admin_bp.admin', estado='APROBADO', sociedad=sociedad if sociedad else None, q=q if q else None, desde=desde if desde else None, hasta=hasta if hasta else None, valor_min=valor_min if valor_min else None, valor_max=valor_max if valor_max else None, per_page=per_page) }}">
        Aprobados: {{ counts_by_status['APROBADO'] }}
      </a>
      <a class="badge bg-danger text-decoration-none"
         href="{{ url_for('admin_bp.admin', estado='RECHAZADO', sociedad=sociedad if sociedad else None, q=q if q else None, desde=desde if desde else None, hasta=hasta if hasta else None, valor_min=valor_min if valor_min else None, valor_max=valor_max if valor_max else None, per_page=per_page) }}">
        Rechazados: {{ counts_by_status['RECHAZADO'] }}
      </a>
    </div>
    <div class="mt-1 small text-muted">
      Σ Total filtrado: ${{ "{:,}".format(sum_total or 0) }}
      &nbsp;|&nbsp; Pend: ${{ "{:,}".format(sums_by_status['PENDIENTE'] or 0) }}
      &nbsp;·&nbsp; Apr: ${{ "{:,}".format(sums_by_status['APROBADO'] or 0) }}
      &nbsp;·&nbsp; Rech: ${{ "{:,}".format(sums_by_status['RECHAZADO'] or 0) }}
    </div>
    {% endif %}
  </div>

  <div class="d-flex gap-2">
    <!-- Exportar TODO (respeta filtro de estado si existe) -->
    <a class="btn btn-outline-success btn-sm"
       href="{{ url_for('admin_bp.export_payments_excel', estado=estado if estado else None, sociedad=sociedad if sociedad else None, q=q if q else None, desde=desde if desde else None, hasta=hasta if hasta else None, valor_min=valor_min if valor_min else None, valor_max=valor_max if valor_max else None) }}">
      Exportar Excel
    </a>
    <!-- Exportar TODO con hoja de imágenes -->
    <a class="btn btn-success btn-sm"
       href="{{ url_for('admin_bp.export_payments_excel', estado=estado if estado else None, sociedad=sociedad if sociedad else None, q=q if q else None, desde=desde if desde else None, hasta=hasta if hasta else None, valor_min=valor_min if valor_min else None, valor_max=valor_max if valor_max else None, imagenes=1) }}">
      Excel + Imágenes
    </a>
  </div>
</div>

<!-- CONTROLES: BÚSQUEDA / FILTROS -->
<form method="get" class="card card-body py-2 px-3 mb-3 sticky-top shadow-sm">
  <div class="row g-2 align-items-end">
    <div class="col-12 col-lg-4">
      <label class="form-label mb-0 small">Buscar</label>
      <input type="text" class="form-control form-control-sm" name="q" value="{{ q or '' }}" placeholder="Cliente, medio o sucursal">
    </div>
    <div class="col-6 col-md-3 col-lg-2">
      <label class="form-label mb-0 small">Estado</label>
      <select class="form-select form-select-sm" name="estado" onchange="this.form.submit()">
        <option value="">Todos</option>
        <option value="PENDIENTE" {{ 'selected' if estado=='PENDIENTE' else '' }}>Pendiente</option>
        <option value="APROBADO"  {{ 'selected' if estado=='APROBADO'  else '' }}>Aprobado</option>
        <option value="RECHAZADO" {{ 'selected' if estado=='RECHAZADO' else '' }}>Rechazado</option>
      </select>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
      <label class="form-label mb-0 small">Sociedad</label>
      <select class="form-select form-select-sm" name="sociedad" onchange="this.form.submit()">
        <option value="">Todas</option>
        <option value="COANDES" {{ 'selected' if sociedad=='COANDES' else '' }}>COANDES</option>
        <option value="MANCHESTER" {{ 'selected' if sociedad=='MANCHESTER' else '' }}>MANCHESTER</option>
        <option value="ALMACENES" {{ 'selected' if sociedad=='ALMACENES' else '' }}>ALMACENES</option>
      </select>
    </div>
    <div class="col-6 col-md-2 col-lg-1">
      <label class="form-label mb-0 small">Por página</label>
      <select class="form-select form-select-sm" name="per_page" onchange="this.form.submit()">
        {% for n in [10,25,50,100] %}
          <option value="{{ n }}" {{ 'selected' if per_page==n else '' }}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-lg-3">
      <input type="hidden" name="page" value="1">
      <div class="d-grid gap-2 d-sm-flex justify-content-lg-end">
        <button type="submit" class="btn btn-primary btn-sm">Aplicar</button>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_bp.admin') }}">Limpiar</a>
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosAvanzados" aria-expanded="{{ 'true' if (desde or hasta or valor_min or valor_max) else 'false' }}" aria-controls="filtrosAvanzados">Más filtros</button>
      </div>
    </div>
  </div>
  <div class="collapse mt-2 {{ 'show' if (desde or hasta or valor_min or valor_max) else '' }}" id="filtrosAvanzados">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-lg-5">
        <label class="form-label mb-0 small">Rango de fechas</label>
        <div class="row g-2">
          <div class="col-6">
            <input type="date" class="form-control form-control-sm" name="desde" value="{{ desde or '' }}" placeholder="Desde">
          </div>
          <div class="col-6">
            <input type="date" class="form-control form-control-sm" name="hasta" value="{{ hasta or '' }}" placeholder="Hasta">
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <label class="form-label mb-0 small">Rango de valor</label>
        <div class="row g-2">
          <div class="col-6">
            <input type="number" class="form-control form-control-sm" name="valor_min" value="{{ valor_min or '' }}" min="0" step="1" placeholder="Mín">
          </div>
          <div class="col-6">
            <input type="number" class="form-control form-control-sm" name="valor_max" value="{{ valor_max or '' }}" min="0" step="1" placeholder="Máx">
          </div>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- TABLA -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="col-id text-nowrap">ID</th>
            <th class="col-cliente">Cliente</th>
            <th class="col-valor text-end text-nowrap">Valor</th>
            <th class="col-medio text-nowrap">Medio</th>
            <th class="col-sucursal">Sucursal</th>
            <th class="col-fcons text-nowrap">F. consignación</th>
            <th class="d-none d-md-table-cell col-soc text-nowrap">Sociedad</th>
            <th class="d-none d-lg-table-cell text-nowrap">Creado (local)</th>
            <th class="d-none d-lg-table-cell text-nowrap">Actualizado (local)</th>
            <th class="col-estado text-nowrap">Estado</th>
            <th class="col-evid text-center d-none d-sm-table-cell">Evidencias</th>
            <th class="col-actions text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
        {% for p in pagos %}
          <tr>
            <td class="col-id text-nowrap">#{{ p.id }}</td>
            <td class="col-cliente"><span class="truncate d-block text-truncate" title="{{ p.cliente or p.referencia }}">{{ p.cliente or p.referencia }}</span></td>
            <td class="col-valor text-end text-nowrap">${{ "{:,}".format(p.valor or 0) }}</td>
            <td class="col-medio text-nowrap">{{ p.medio_pago }}</td>
            <td class="col-sucursal"><span class="truncate d-block text-truncate" title="{{ p.sucursal }}">{{ p.sucursal }}</span></td>
            <td class="col-fcons text-nowrap">{{ p.fecha_consignacion.isoformat() if p.fecha_consignacion else '—' }}</td>
            <td class="d-none d-md-table-cell col-soc text-nowrap">{{ p.sociedad.value if p.sociedad else '—' }}</td>
            <td class="d-none d-lg-table-cell text-nowrap">{{ p.created_local_str or '—' }}</td>
            <td class="d-none d-lg-table-cell text-nowrap">{{ p.updated_local_str or '—' }}</td>
            <td class="col-estado text-nowrap">
              {% set est = p.estado.value %}
              {% set badge_class = 'bg-secondary' if est=='PENDIENTE' else ('bg-success' if est=='APROBADO' else 'bg-danger') %}
              {% set abbr = 'Pen' if est=='PENDIENTE' else ('Apr' if est=='APROBADO' else 'Rech') %}
              <span class="badge {{ badge_class }}" title="{{ est }}">{{ abbr }}</span>
            </td>
            <td class="col-evid text-center d-none d-sm-table-cell">
              {% set cnt = p.evidences|length %}
              {% if cnt > 0 %}
                <a href="#" class="badge bg-primary text-decoration-none"
                   data-bs-toggle="modal" data-bs-target="#modalEvid-{{ p.id }}"
                   title="Ver imágenes">{{ cnt }}</a>
              {% else %}
                <span class="badge bg-secondary">0</span>
              {% endif %}
            </td>
            <td class="col-actions text-center text-md-start text-nowrap">
              {% if p.estado.value == 'PENDIENTE' %}
                <div class="btn-group">
                  <button type="button" class="btn btn-success btn-sm btn-approve" title="Aprobar" aria-label="Aprobar"
                          data-approve-url="{{ url_for('admin_bp.approve', pid=p.id) }}"
                          data-pid="{{ p.id }}">
                    <i class="bi bi-check-lg"></i><span class="ms-1 d-none d-sm-inline">Apr</span>
                  </button>
                  <button type="button" class="btn btn-outline-danger btn-sm" title="Rechazar" aria-label="Rechazar"
                          data-bs-toggle="modal" data-bs-target="#modalRechazo-{{ p.id }}">
                    <i class="bi bi-x-circle"></i><span class="ms-1 d-none d-sm-inline">Rech</span>
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" title="Detalles" aria-label="Detalles"
                          data-bs-toggle="modal" data-bs-target="#modalPago-{{ p.id }}">
                    <i class="bi bi-eye"></i><span class="ms-1 d-none d-sm-inline">Det</span>
                  </button>
                </div>
                <form method="post" id="form-{{ p.id }}" class="d-none">
                  <input type="hidden" name="motivo" id="motivo-{{ p.id }}">
                </form>
              {% else %}
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-secondary btn-sm" title="Detalles" aria-label="Detalles"
                          data-bs-toggle="modal" data-bs-target="#modalPago-{{ p.id }}">
                    <i class="bi bi-eye"></i><span class="ms-1 d-none d-sm-inline">Det</span>
                  </button>
                </div>
              {% endif %}
            </td>
          </tr>
          <!-- Modal Detalles -->
          <div class="modal fade" id="modalPago-{{ p.id }}" tabindex="-1" aria-labelledby="modalPagoLabel-{{ p.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalPagoLabel-{{ p.id }}">Detalle de pago #{{ p.id }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <dl class="row mb-0">
                    <dt class="col-5">Cliente</dt><dd class="col-7">{{ p.cliente or p.referencia }}</dd>
                    <dt class="col-5">Valor</dt><dd class="col-7">${{ "{:,}".format(p.valor or 0) }}</dd>
                    <dt class="col-5">Medio</dt><dd class="col-7">{{ p.medio_pago }}</dd>
                    <dt class="col-5">Sucursal</dt><dd class="col-7">{{ p.sucursal }}</dd>
                    <dt class="col-5">Sociedad</dt><dd class="col-7">{{ p.sociedad.value if p.sociedad else '—' }}</dd>
                    <dt class="col-5">F. consignación</dt><dd class="col-7">{{ p.fecha_consignacion.isoformat() if p.fecha_consignacion else '—' }}</dd>
                    <dt class="col-5">Estado</dt><dd class="col-7">{{ p.estado.value }}</dd>
                    <dt class="col-5">Creado (local)</dt><dd class="col-7">{{ p.created_local_str or '—' }}</dd>
                    <dt class="col-5">Actualizado (local)</dt><dd class="col-7">{{ p.updated_local_str or '—' }}</dd>
                    <dt class="col-5">Creado UTC</dt><dd class="col-7">{{ p.created_at.isoformat(sep=' ') if p.created_at else '—' }}</dd>
                    <dt class="col-5">Actualizado UTC</dt><dd class="col-7">{{ p.updated_at.isoformat(sep=' ') if p.updated_at else '—' }}</dd>
                  </dl>
                  <hr>
                  <div>
                    <div class="fw-semibold mb-2">Evidencias</div>
                    {% if p.evidences|length == 0 %}
                      <span class="text-muted">—</span>
                    {% else %}
                      <ul class="list-unstyled mb-0">
                        {% for ev in p.evidences %}
                          <li>
                            <a href="{{ url_for('admin_bp.evidence_view', evid_id=ev.id) }}" target="_blank">Ver {{ loop.index }} ({{ ev.filename }})</a>
                          </li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
              </div>
            </div>
          </div>
          <!-- Modal Rechazo -->
          <div class="modal fade" id="modalRechazo-{{ p.id }}" tabindex="-1" aria-labelledby="modalRechazoLabel-{{ p.id }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalRechazoLabel-{{ p.id }}">Rechazar pago #{{ p.id }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">Motivo</label>
                    <textarea class="form-control" id="modal-motivo-{{ p.id }}" rows="3" placeholder="Describe el motivo de rechazo" required></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-danger btn-reject-confirm"
                          data-reject-url="{{ url_for('admin_bp.reject', pid=p.id) }}"
                          data-pid="{{ p.id }}">Rechazar</button>
                </div>
              </div>
            </div>
          </div>
          <!-- Modal Imágenes -->
          <div class="modal fade" id="modalEvid-{{ p.id }}" tabindex="-1" aria-labelledby="modalEvidLabel-{{ p.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalEvidLabel-{{ p.id }}">Imágenes del pago #{{ p.id }}</h5>
                  <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                </div>
                <div class="modal-body">
                  <div id="carouselEvid-{{ p.id }}" class="carousel slide" data-bs-ride="false">
                    <div class="carousel-inner">
                      {% set ns = namespace(count=0) %}
                      {% for ev in p.evidences %}
                        {% set fname = (ev.filename or '')|lower %}
                        {% if fname.endswith('.jpg') or fname.endswith('.jpeg') or fname.endswith('.png') %}
                          {% set ns.count = ns.count + 1 %}
                          <div class="carousel-item {{ 'active' if ns.count == 1 else '' }}">
                            <div class="evid-view" style="height:70vh; overflow:auto; background:#000; display:flex; align-items:center; justify-content:center;">
                              <img src="{{ url_for('admin_bp.evidence_view', evid_id=ev.id) }}" class="evid-img img-fit" alt="Evidencia {{ ns.count }}">
                            </div>
                          </div>
                        {% endif %}
                      {% endfor %}
                      {% if ns.count == 0 %}
                        <div class="text-center text-muted">No hay imágenes para este pago. Usa “Detalles” para ver otros archivos.</div>
                      {% endif %}
                    </div>
                    {% if ns.count > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselEvid-{{ p.id }}" data-bs-slide="prev">
                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselEvid-{{ p.id }}" data-bs-slide="next">
                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">Siguiente</span>
                    </button>
                    {% endif %}
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                  <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalPago-{{ p.id }}">Detalles</button>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Toast container for action feedback -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="actionToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <style>
    .evid-img.img-fit{max-height:100%;max-width:100%;object-fit:contain;cursor:zoom-in}
    .evid-img.zoomed{max-width:none;max-height:none;width:auto;height:auto;object-fit:none;cursor:zoom-out}
    /* Column widths for better layout */
    .table .col-id{width:72px}
    .table .col-valor{width:120px}
    .table .col-medio{width:120px}
    .table .col-fcons{width:130px}
    .table .col-estado{width:110px}
    .table .col-evid{width:64px}
    .table .col-actions{width:180px}
    @media (max-width: 576px){ .table .col-actions{width:auto} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
  (function(){
    function toggleZoom(img){
      if(!img) return;
      if(img.classList.contains('zoomed')){
        img.classList.remove('zoomed');
        img.style.width = '';
        img.style.height = '';
        if(!img.classList.contains('img-fit')) img.classList.add('img-fit');
      }else{
        img.classList.remove('img-fit');
        img.classList.add('zoomed');
        var scale = 2;
        var nw = img.naturalWidth || 0;
        if(nw>0){ img.style.width = (nw*scale) + 'px'; img.style.height='auto'; }
        else { img.style.width = '150%'; }
      }
    }
    document.addEventListener('click',function(e){
      var btn=e.target.closest('[data-zoom-target]');
      if(btn){
        e.preventDefault();
        var id=btn.getAttribute('data-zoom-target');
        var car=document.getElementById(id);
        if(!car)return;
        var img=car.querySelector('.carousel-item.active .evid-img');
        toggleZoom(img);
      }
      var imgEl=e.target.closest('.evid-img');
      if(imgEl){toggleZoom(imgEl);}
    });
    var modals=document.querySelectorAll('[id^="modalEvid-"]');
    modals.forEach(function(modal){
      modal.addEventListener('hidden.bs.modal',function(){
        modal.querySelectorAll('.evid-img').forEach(function(img){
          img.classList.remove('zoomed');
          img.style.width = '';
          img.style.height = '';
          if(!img.classList.contains('img-fit')) img.classList.add('img-fit');
        });
      });
      var car=modal.querySelector('.carousel');
      if(car){
        car.addEventListener('slid.bs.carousel',function(){
          car.querySelectorAll('.evid-img').forEach(function(img){
            img.classList.remove('zoomed');
            img.style.width = '';
            img.style.height = '';
            if(!img.classList.contains('img-fit')) img.classList.add('img-fit');
          });
        });
      }
    });

    // SweetAlert2: Confirmar aprobación
    document.addEventListener('click', function(e){
      var approveBtn = e.target.closest('.btn-approve');
      if(!approveBtn) return;
      e.preventDefault();
      var url = approveBtn.getAttribute('data-approve-url');
      var pid = approveBtn.getAttribute('data-pid');
      Swal.fire({
        title: '¿Aprobar pago #' + pid + '?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, aprobar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#198754'
      }).then(function(res){
        if(res.isConfirmed){
          // disable button and show spinner
          approveBtn.disabled = true;
          approveBtn.dataset.oldHtml = approveBtn.innerHTML;
          approveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Aprobando...';
          // prepare form submit
          var form = document.getElementById('form-'+pid);
          if(!form){
            form = document.createElement('form');
            form.method = 'post';
            form.id = 'form-'+pid;
            document.body.appendChild(form);
          }
          var existingMotivo = document.getElementById('motivo-'+pid);
          if(existingMotivo && existingMotivo.parentElement === form){ existingMotivo.remove(); }
          // set session flag for toast
          try{ sessionStorage.setItem('vp_action', JSON.stringify({t:'approve', pid: pid})); }catch(e){}
          form.setAttribute('action', url);
          form.submit();
        }
      });
    });

    // SweetAlert2: Confirmar rechazo (usa modal para capturar motivo)
    document.addEventListener('click', function(e){
      var rejectBtn = e.target.closest('.btn-reject-confirm');
      if(!rejectBtn) return;
      e.preventDefault();
      var url = rejectBtn.getAttribute('data-reject-url');
      var pid = rejectBtn.getAttribute('data-pid');
      var motivoTextarea = document.getElementById('modal-motivo-'+pid);
      var motivo = (motivoTextarea && motivoTextarea.value || '').trim();
      if(!motivo){
        Swal.fire({icon:'warning', title:'Motivo requerido', text:'Por favor ingresa un motivo de rechazo.'});
        return;
      }
      var modalEl = document.getElementById('modalRechazo-'+pid);
      try { var inst = bootstrap.Modal.getInstance(modalEl); if(inst) inst.hide(); } catch(err) {}
      Swal.fire({
        title: '¿Rechazar pago #' + pid + '?',
        text: motivo.length > 140 ? motivo.slice(0,140) + '…' : motivo,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, rechazar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#dc3545'
      }).then(function(res){
        if(res.isConfirmed){
          // disable reject button and show spinner
          rejectBtn.disabled = true;
          rejectBtn.dataset.oldHtml = rejectBtn.innerHTML;
          rejectBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Rechazando...';
          var form = document.getElementById('form-'+pid);
          if(!form){
            form = document.createElement('form');
            form.method = 'post';
            form.id = 'form-'+pid;
            document.body.appendChild(form);
          }
          var motivoHidden = document.getElementById('motivo-'+pid);
          if(!motivoHidden){
            motivoHidden = document.createElement('input');
            motivoHidden.type = 'hidden';
            motivoHidden.name = 'motivo';
            motivoHidden.id = 'motivo-'+pid;
            form.appendChild(motivoHidden);
          }
          motivoHidden.value = motivo;
          // set session flag for toast
          try{ sessionStorage.setItem('vp_action', JSON.stringify({t:'reject', pid: pid})); }catch(e){}
          form.setAttribute('action', url);
          form.submit();
        }
      });
    });

    // Show toast if coming from an action (ensure Bootstrap is loaded)
    window.addEventListener('load', function(){
      try{
        // Enable Bootstrap tooltips for action buttons
        try{
          var ttEls = document.querySelectorAll('.col-actions [title]');
          ttEls.forEach(function(el){ new bootstrap.Tooltip(el, {container:'body', trigger:'hover focus', placement:'top'}); });
        }catch(e){}

        var act = sessionStorage.getItem('vp_action');
        if(act){
          sessionStorage.removeItem('vp_action');
          var data = {};
          try{ data = JSON.parse(act) || {}; }catch(e){}
          var toastEl = document.getElementById('actionToast');
          if(toastEl){
            var body = toastEl.querySelector('.toast-body');
            var ok = (data.t === 'approve' || data.t === 'reject');
            toastEl.classList.remove('text-bg-success','text-bg-danger','bg-success','bg-danger','text-white');
            if(data.t === 'approve'){
              body.textContent = 'Pago #' + (data.pid || '') + ' aprobado correctamente';
              toastEl.classList.add('text-bg-success','bg-success','text-white');
            } else if(data.t === 'reject'){
              body.textContent = 'Pago #' + (data.pid || '') + ' rechazado correctamente';
              toastEl.classList.add('text-bg-danger','bg-danger','text-white');
            } else {
              body.textContent = 'Acción completada';
              toastEl.classList.add('text-bg-success','bg-success','text-white');
            }
            var toast = new bootstrap.Toast(toastEl, {delay: 3000});
            toast.show();
          }
        }
      }catch(e){}
    });
  })();
  </script>

  <!-- PAGINACIÓN -->
  {% set pages = (total // per_page) + (1 if total % per_page else 0) %}
  {% if pages > 1 %}
  <div class="card-footer bg-white">
    <nav aria-label="Paginación">
      <ul class="pagination justify-content-end mb-0">
        <li class="page-item {{ 'disabled' if page<=1 }}">
          <a class="page-link"
             href="{{ url_for('admin_bp.admin', page=page-1, per_page=per_page, estado=estado, sociedad=sociedad, q=q, desde=desde if desde else None, hasta=hasta if hasta else None, valor_min=valor_min if valor_min else None, valor_max=valor_max if valor_max else None) }}">&laquo; Anterior</a>
        </li>

        {# Compacta: primeras/últimas + vecinas #}
        {% set window = 2 %}
        {% for pnum in range(1, pages+1) %}
          {% if pnum == 1 or pnum == pages or (pnum >= page-window and pnum <= page+window) %}
            <li class="page-item {{ 'active' if pnum==page }}">
              <a class="page-link"
                 href="{{ url_for('admin_bp.admin', page=pnum, per_page=per_page, estado=estado, sociedad=sociedad, q=q, desde=desde if desde else None, hasta=hasta if hasta else None, valor_min=valor_min if valor_min else None, valor_max=valor_max if valor_max else None) }}">{{ pnum }}</a>
            </li>
          {% elif pnum == 2 and page-window > 2 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% elif pnum == pages-1 and page+window < pages-1 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endfor %}

        <li class="page-item {{ 'disabled' if page>=pages }}">
          <a class="page-link"
             href="{{ url_for('admin_bp.admin', page=page+1, per_page=per_page, estado=estado, sociedad=sociedad, q=q, desde=desde if desde else None, hasta=hasta if hasta else None, valor_min=valor_min if valor_min else None, valor_max=valor_max if valor_max else None) }}">Siguiente &raquo;</a>
        </li>
      </ul>
    </nav>
  </div>
  {% endif %}
</div>

{% endblock %}


